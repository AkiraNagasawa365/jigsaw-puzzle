# CI/CD ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

## ğŸ“Š 1æšã§åˆ†ã‹ã‚‹CI/CDæ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é–‹ç™ºãƒ•ãƒ­ãƒ¼                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ã‚³ãƒ¼ãƒ‰å¤‰æ›´
      â†“
  git push
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           GitHub Actions (OIDCèªè¨¼ã§AWSã¸)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘  CI                  â”‚ ãƒ†ã‚¹ãƒˆãƒ»Lint                â”‚
â”‚ â‘¡ Lambda Deploy       â”‚ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤        â”‚
â”‚ â‘¢ Frontend Deploy     â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤      â”‚
â”‚ â‘£ Terraform Apply     â”‚ ã‚¤ãƒ³ãƒ•ãƒ©æ›´æ–°                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AWSç’°å¢ƒ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ãƒ»Lambda (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰)                               â”‚
â”‚ ãƒ»S3 + CloudFront (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰)                    â”‚
â”‚ ãƒ»DynamoDB, API Gateway, Cognito                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€æ—©è¦‹è¡¨

### èªè¨¼ï¼ˆGitHub â†’ AWSï¼‰

| ä½•ã‚’ | ã©ã“ã« |
|------|--------|
| OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ | `terraform/modules/github-oidc/main.tf` |
| ãƒ­ãƒ¼ãƒ«ARN | GitHub Secrets (`AWS_ROLE_ARN`) |

### TerraformçŠ¶æ…‹ç®¡ç†

| ä½•ã‚’ | ã©ã“ã« |
|------|--------|
| S3ãƒã‚±ãƒƒãƒˆä½œæˆ | `terraform/bootstrap/main.tf` |
| S3ã‚’ä½¿ã†è¨­å®š | `terraform/environments/*/backend.tf` |
| å®Ÿéš›ã®çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ« | S3: `s3://jigsaw-puzzle-terraform-state/*/terraform.tfstate` |

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

| ä½•ã‚’ | ã©ã“ã« | ã„ã¤ |
|------|--------|------|
| ãƒ†ã‚¹ãƒˆ | `.github/workflows/ci.yml` | å…¨push |
| Lambdaãƒ‡ãƒ—ãƒ­ã‚¤ | `.github/workflows/deploy-lambda.yml` | `backend/` å¤‰æ›´ |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤ | `.github/workflows/deploy-frontend.yml` | `frontend/` å¤‰æ›´ |
| Terraformãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ | `.github/workflows/terraform-plan.yml` | PRä½œæˆ |
| Terraformãƒ‡ãƒ—ãƒ­ã‚¤ | `.github/workflows/terraform-apply.yml` | `terraform/` å¤‰æ›´ |

---

## âš¡ ã‚ˆãã‚ã‚‹æ“ä½œ

### ãƒ­ãƒ¼ã‚«ãƒ«ã§Terraformå®Ÿè¡Œ

```bash
# prodç’°å¢ƒ
cd terraform/environments/prod
terraform plan   # ç¢ºèª
terraform apply  # é©ç”¨

# devç’°å¢ƒ
cd terraform/environments/dev
terraform plan
terraform apply
```

### GitHub Actionsã‚’æ‰‹å‹•å®Ÿè¡Œ

```bash
# Terraform Applyã‚’æ‰‹å‹•å®Ÿè¡Œï¼ˆprodç’°å¢ƒï¼‰
gh workflow run "Terraform Apply" -f environment=prod

# Lambda Deployã‚’æ‰‹å‹•å®Ÿè¡Œ
gh workflow run "Deploy Lambda" -f environment=prod
```

### çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª

```bash
# S3ã®çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
aws s3 ls s3://jigsaw-puzzle-terraform-state/ --recursive

# ç‰¹å®šã®çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
aws s3 cp s3://jigsaw-puzzle-terraform-state/prod/terraform.tfstate .
```

---

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### âœ… åŸºæœ¬ç¢ºèª

- [ ] GitHub Secrets ã« `AWS_ROLE_ARN` è¨­å®šæ¸ˆã¿ï¼ˆprod/devä¸¡æ–¹ï¼‰
- [ ] Bootstrapå®Ÿè¡Œæ¸ˆã¿ï¼ˆ`terraform/bootstrap/`ï¼‰
- [ ] S3ãƒã‚±ãƒƒãƒˆå­˜åœ¨ç¢ºèªï¼ˆ`aws s3 ls | grep terraform-state`ï¼‰
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§terraform initã§ãã‚‹ã‹

### âŒ ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | è§£æ±º |
|--------|------|------|
| OIDCèªè¨¼ã‚¨ãƒ©ãƒ¼ | SecretsãŒæœªè¨­å®š | GitHub Secretsã‚’ç¢ºèª |
| çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ | BootstrapãŒæœªå®Ÿè¡Œ | `terraform/bootstrap/` ã‚’å®Ÿè¡Œ |
| ãƒªã‚½ãƒ¼ã‚¹ãŒæ—¢ã«å­˜åœ¨ | çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ä¸ä¸€è‡´ | `terraform import` ã§çŠ¶æ…‹ã‚’åŒæœŸ |

---

## ğŸ¯ è¦šãˆã¦ãŠãã¹ã3ã¤ã®ãƒã‚¤ãƒ³ãƒˆ

1. **Bootstrap â†’ ç’°å¢ƒ**
   - æœ€åˆã« `terraform/bootstrap/` ã‚’å®Ÿè¡Œï¼ˆ1å›ã ã‘ï¼‰
   - ãã®å¾Œ `terraform/environments/*/` ã‚’ä½¿ç”¨

2. **ãƒ–ãƒ©ãƒ³ãƒ = ç’°å¢ƒ**
   - `develop` ãƒ–ãƒ©ãƒ³ãƒ â†’ devç’°å¢ƒ
   - `main` ãƒ–ãƒ©ãƒ³ãƒ â†’ prodç’°å¢ƒ

3. **push = è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤**
   - ã‚³ãƒ¼ãƒ‰å¤‰æ›´ â†’ è©²å½“ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè‡ªå‹•å®Ÿè¡Œ
   - PRã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ ãƒãƒ¼ã‚¸ã§è‡ªå‹•åæ˜ 

---

## ğŸ“ ã‚‚ã£ã¨è©³ã—ãçŸ¥ã‚ŠãŸã„

- å…¨ä½“æ§‹æˆ: [cicd-architecture.md](./cicd-architecture.md)
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦: [CLAUDE.md](../CLAUDE.md)
- ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ: [system-design.md](./system-design.md)
