# CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹æˆå›³

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®CI/CDãŒã©ã“ã«ä½•ã‚’æ›¸ã„ã¦ã„ã‚‹ã‹ã‚‰æˆã‚Šç«‹ã£ã¦ã„ã‚‹ã‹ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ¯ å…¨ä½“åƒ

```
GitHub Push
    â†“
GitHub Actions (OIDCèªè¨¼)
    â†“
AWS (Lambda/S3/Terraform)
```

---

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¨å½¹å‰²

### 1. èªè¨¼åŸºç›¤ï¼ˆGitHub â†’ AWSï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `terraform/modules/github-oidc/main.tf` | GitHub OIDC Provider + IAMãƒ­ãƒ¼ãƒ«å®šç¾© |
| GitHub Secrets: `AWS_ROLE_ARN` | ãƒ­ãƒ¼ãƒ«ARNã‚’ä¿å­˜ï¼ˆç’°å¢ƒã”ã¨ï¼‰ |

**ã“ã‚ŒãŒã‚ã‚‹ã‹ã‚‰:** GitHub ActionsãŒAWSã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ï¼ˆé•·æœŸã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ä¸è¦ï¼‰

---

### 2. Terraform çŠ¶æ…‹ç®¡ç†

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `terraform/bootstrap/main.tf` | S3ãƒã‚±ãƒƒãƒˆ + DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ |
| `terraform/environments/*/backend.tf` | S3ã‚’çŠ¶æ…‹ä¿å­˜å…ˆã«æŒ‡å®š |

**ã“ã‚ŒãŒã‚ã‚‹ã‹ã‚‰:** ãƒ­ãƒ¼ã‚«ãƒ«ã¨GitHub Actionsã§åŒã˜çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…±æœ‰ã§ãã‚‹

**S3ã®ä¸­èº«:**
```
s3://jigsaw-puzzle-terraform-state/
  â”œâ”€â”€ dev/terraform.tfstate    â† devç’°å¢ƒã®çŠ¶æ…‹
  â””â”€â”€ prod/terraform.tfstate   â† prodç’°å¢ƒã®çŠ¶æ…‹
```

---

### 3. GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

#### ğŸ“‹ CIï¼ˆãƒ†ã‚¹ãƒˆï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒˆãƒªã‚¬ãƒ¼ | å†…å®¹ |
|---------|---------|------|
| `.github/workflows/ci.yml` | å…¨pushã§å®Ÿè¡Œ | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰/ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆãƒ»Lint |

**ã“ã‚ŒãŒã‚ã‚‹ã‹ã‚‰:** ã‚³ãƒ¼ãƒ‰å“è³ªã‚’è‡ªå‹•ãƒã‚§ãƒƒã‚¯

---

#### ğŸš€ Lambda Deployï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒˆãƒªã‚¬ãƒ¼ | å†…å®¹ |
|---------|---------|------|
| `.github/workflows/deploy-lambda.yml` | `backend/app/`, `lambda/` å¤‰æ›´æ™‚ | Lambdaé–¢æ•°ã‚³ãƒ¼ãƒ‰æ›´æ–° |
| `scripts/deploy-lambda.sh` | â†‘ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ | zipãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ â†’ AWS Lambdaæ›´æ–° |

**ãƒ–ãƒ©ãƒ³ãƒåˆ†å²:**
- `main` ãƒ–ãƒ©ãƒ³ãƒ â†’ prodç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
- `develop` ãƒ–ãƒ©ãƒ³ãƒ â†’ devç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤

**ã“ã‚ŒãŒã‚ã‚‹ã‹ã‚‰:** ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã®pushã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

---

#### ğŸ¨ Frontend Deployï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒˆãƒªã‚¬ãƒ¼ | å†…å®¹ |
|---------|---------|------|
| `.github/workflows/deploy-frontend.yml` | `frontend/` å¤‰æ›´æ™‚ | React ãƒ“ãƒ«ãƒ‰ â†’ S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ CloudFrontç„¡åŠ¹åŒ– |
| `scripts/deploy-frontend.sh` | â†‘ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ | npm build â†’ S3 sync â†’ CloudFront invalidation |

**ãƒ–ãƒ©ãƒ³ãƒåˆ†å²:**
- `main` ãƒ–ãƒ©ãƒ³ãƒ â†’ prodç’°å¢ƒï¼ˆCloudFrontï¼‰
- `develop` ãƒ–ãƒ©ãƒ³ãƒ â†’ devç’°å¢ƒï¼ˆCloudFrontï¼‰

**ã“ã‚ŒãŒã‚ã‚‹ã‹ã‚‰:** ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã®pushã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

---

#### ğŸ—ï¸ Terraform Planï¼ˆã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒˆãƒªã‚¬ãƒ¼ | å†…å®¹ |
|---------|---------|------|
| `.github/workflows/terraform-plan.yml` | PRä½œæˆæ™‚ã€`terraform/` å¤‰æ›´æ™‚ | terraform plan â†’ PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ |

**ã“ã‚ŒãŒã‚ã‚‹ã‹ã‚‰:** ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã‚‹

---

#### ğŸ—ï¸ Terraform Applyï¼ˆã‚¤ãƒ³ãƒ•ãƒ©è‡ªå‹•æ›´æ–°ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒˆãƒªã‚¬ãƒ¼ | å†…å®¹ |
|---------|---------|------|
| `.github/workflows/terraform-apply.yml` | `terraform/` å¤‰æ›´æ™‚ | terraform apply â†’ ã‚¤ãƒ³ãƒ•ãƒ©æ›´æ–° |

**ãƒ–ãƒ©ãƒ³ãƒåˆ†å²:**
- `main` ãƒ–ãƒ©ãƒ³ãƒ â†’ prodç’°å¢ƒã‚’æ›´æ–°
- `develop` ãƒ–ãƒ©ãƒ³ãƒ â†’ devç’°å¢ƒã‚’æ›´æ–°

**ã“ã‚ŒãŒã‚ã‚‹ã‹ã‚‰:** ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´ãŒè‡ªå‹•åæ˜ ã•ã‚Œã‚‹

---

## ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰å¤‰æ›´

```
1. backend/app/puzzle_service.py ã‚’ç·¨é›†
   â†“
2. git push origin main
   â†“
3. GitHub Actionsç™ºå‹•
   - CI: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ âœ“
   - deploy-lambda.yml: Lambdaæ›´æ–° âœ“
   â†“
4. å®Œäº†ï¼ˆç´„2åˆ†ï¼‰
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰å¤‰æ›´

```
1. frontend/src/App.tsx ã‚’ç·¨é›†
   â†“
2. git push origin main
   â†“
3. GitHub Actionsç™ºå‹•
   - CI: Lintå®Ÿè¡Œ âœ“
   - deploy-frontend.yml: S3+CloudFrontæ›´æ–° âœ“
   â†“
4. å®Œäº†ï¼ˆç´„3åˆ†ï¼‰
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´

```
1. terraform/environments/prod/main.tf ã‚’ç·¨é›†
   â†“
2. PRä½œæˆ
   â†“
3. terraform-plan.yml: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
   â†“
4. ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€ãƒãƒ¼ã‚¸
   â†“
5. terraform-apply.yml: è‡ªå‹•é©ç”¨
   â†“
6. å®Œäº†
```

---

## ğŸ” èªè¨¼ã®ä»•çµ„ã¿

### GitHub Actions â†’ AWS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. GitHub Actionsèµ·å‹•               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. GitHub ãŒ OIDC ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ      â”‚
â”‚    "ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®mainãƒ–ãƒ©ãƒ³ãƒ"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. AWS STS ãŒæ¤œè¨¼                   â”‚
â”‚    terraform/modules/github-oidc/   â”‚
â”‚    ã®Trust Policyã§ç¢ºèª             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ä¸€æ™‚ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ç™ºè¡Œ           â”‚
â”‚    (15åˆ†ã€œ1æ™‚é–“æœ‰åŠ¹)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. AWSæ“ä½œå¯èƒ½                      â”‚
â”‚    ãƒ»Lambdaæ›´æ–°                     â”‚
â”‚    ãƒ»S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰                 â”‚
â”‚    ãƒ»Terraformå®Ÿè¡Œ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«:**
- `terraform/modules/github-oidc/main.tf` (Trust Policyå®šç¾©)
- GitHub Secrets: `AWS_ROLE_ARN` (ãƒ­ãƒ¼ãƒ«æŒ‡å®š)

---

## ğŸŒ ç’°å¢ƒåˆ†é›¢

### ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥

| ãƒ–ãƒ©ãƒ³ãƒ | ç’°å¢ƒ | URL |
|---------|------|-----|
| `develop` | dev | https://dykwhpbm0bhdv.cloudfront.net |
| `main` | prod | https://d1tucwzc87xq8x.cloudfront.net |

### ç’°å¢ƒã”ã¨ã®è¨­å®š

```
terraform/environments/
  â”œâ”€â”€ dev/
  â”‚   â”œâ”€â”€ backend.tf         â† S3ã‚­ãƒ¼: dev/terraform.tfstate
  â”‚   â”œâ”€â”€ main.tf            â† devå›ºæœ‰ã®è¨­å®š
  â”‚   â””â”€â”€ variables.tf       â† ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤: dev
  â”‚
  â””â”€â”€ prod/
      â”œâ”€â”€ backend.tf         â† S3ã‚­ãƒ¼: prod/terraform.tfstate
      â”œâ”€â”€ main.tf            â† prodå›ºæœ‰ã®è¨­å®š
      â””â”€â”€ variables.tf       â† ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤: prod
```

**ã“ã‚ŒãŒã‚ã‚‹ã‹ã‚‰:** dev/prodãŒå®Œå…¨ã«åˆ†é›¢ã•ã‚Œã‚‹

---

## ğŸ“¦ é‡è¦ãªä¾å­˜é–¢ä¿‚

### Bootstrap â†’ ç’°å¢ƒ

```
terraform/bootstrap/  (æœ€åˆã«1å›ã ã‘å®Ÿè¡Œ)
  â†“ S3ãƒã‚±ãƒƒãƒˆä½œæˆ
terraform/environments/dev/
terraform/environments/prod/
  â†“ S3ã‚’å‚ç…§
```

**é †åºãŒé‡è¦:** Bootstrapã‚’å…ˆã«å®Ÿè¡Œã—ãªã„ã¨ç’°å¢ƒãŒå‹•ã‹ãªã„

---

## ğŸ¯ ã¾ã¨ã‚ï¼šã©ã“ã«ä½•ãŒã‚ã‚‹ã‹

| æ©Ÿèƒ½ | ãƒ•ã‚¡ã‚¤ãƒ« | ä¸€è¨€ |
|------|---------|------|
| **èªè¨¼** | `terraform/modules/github-oidc/` | GitHubã‹ã‚‰AWSã«ãƒ­ã‚°ã‚¤ãƒ³ |
| **çŠ¶æ…‹ç®¡ç†** | `terraform/bootstrap/` + `*/backend.tf` | TerraformçŠ¶æ…‹ã‚’S3ã§å…±æœ‰ |
| **CI** | `.github/workflows/ci.yml` | ãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œ |
| **Lambda** | `.github/workflows/deploy-lambda.yml` | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ |
| **Frontend** | `.github/workflows/deploy-frontend.yml` | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ |
| **Terraform** | `.github/workflows/terraform-*.yml` | ã‚¤ãƒ³ãƒ•ãƒ©è‡ªå‹•æ›´æ–° |

**ã“ã‚Œã‚‰ã™ã¹ã¦ãŒæƒã£ã¦ã€å®Œå…¨ãªCI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå®Œæˆã€‚**

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### GitHub ActionsãŒå¤±æ•—ã™ã‚‹

1. **OIDCèªè¨¼ã‚¨ãƒ©ãƒ¼**
   - ç¢ºèª: GitHub Secrets ã« `AWS_ROLE_ARN` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
   - ç¢ºèª: `terraform/modules/github-oidc/main.tf` ã®Trust Policy

2. **TerraformçŠ¶æ…‹ã‚¨ãƒ©ãƒ¼**
   - ç¢ºèª: `terraform/bootstrap/` ãŒå®Ÿè¡Œæ¸ˆã¿ã‹
   - ç¢ºèª: S3ãƒã‚±ãƒƒãƒˆ `jigsaw-puzzle-terraform-state` ãŒå­˜åœ¨ã™ã‚‹ã‹

3. **ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼**
   - ç¢ºèª: Lambdaé–¢æ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ï¼ˆTerraformã§ä½œæˆæ¸ˆã¿ï¼Ÿï¼‰
   - ç¢ºèª: IAMãƒ­ãƒ¼ãƒ«ã«å¿…è¦ãªæ¨©é™ãŒã‚ã‚‹ã‹

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [CLAUDE.md](../CLAUDE.md) - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®æ§‹æˆ
- [system-design.md](./system-design.md) - ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ
- [20251022_github-oidc-setup.md](./20251022_github-oidc-setup.md) - OIDCè¨­å®šæ‰‹é †

ä»¥ä¸Šã€ç°¡æ½”ç‰ˆCI/CDæ§‹æˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã—ãŸï¼
