# Mangum実装ログ（2025-10-22）

## 概要

ローカル開発環境（FastAPI）と本番環境（Lambda）のコード差異を最小化するため、MangumをLambda関数に導入しました。

## 実装前の状態

- **Lambda関数**: `lambda/puzzle-register/index.py` に350行の独自ルーティングロジック
- **問題点**: FastAPIとLambdaで重複したルーティングコード、エンドポイント追加のたびに2箇所修正が必要

## 実装内容

### 1. pyproject.tomlにmangum追加

```toml
dependencies = [
    # ... 既存の依存関係
    "mangum>=0.17.0",
]
```

### 2. Lambda関数の簡素化

**Before (350行)**:
- 独自のルーティングロジック
- 各エンドポイントごとのハンドラー関数
- DecimalEncoder等のカスタムロジック

**After (19行)**:
```python
import sys
import os

sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'backend'))

from mangum import Mangum
from app.api.main import app

handler = Mangum(app, lifespan="off")
```

**削減**: ▼331行

### 3. デプロイスクリプトの修正

Linux互換のパッケージをインストールするロジックを追加しました。

## 試行錯誤の詳細

### 問題1: Editable Packageがrequirements.txtに含まれていた

**エラー**:
```
error: /Users/.../lambda/puzzle-register does not appear to be a Python project
```

**原因**: `uv export` が `-e file://...` 形式のeditable packageをエクスポートしていた

**解決策**:
```bash
grep -v "jigsaw-puzzle" lambda/puzzle-register/requirements-full.txt | \
  grep -v "^-e " | \
  grep -v "file://" > lambda/puzzle-register/requirements.txt
```

### 問題2: 開発依存関係が含まれていた

**エラー**:
```
ERROR: Cannot install -r requirements.txt (line 12) and urllib3==2.5.0
because these package versions have conflicting dependencies.

The conflict is caused by:
    The user requested urllib3==2.5.0
    botocore 1.40.53 depends on urllib3<1.27 and >=1.25.4
```

**原因**: `uv export` が開発用依存関係（pytest, moto等）も含めてエクスポートし、それらが不要な依存関係バージョンを引き込んでいた

**解決策**: `--no-dev` フラグを追加
```bash
uv export --no-hashes --no-dev --format requirements-txt > requirements-full.txt
```

### 問題3: pipの依存関係解決の問題

**エラー**:
```
ERROR: Cannot install urllib3==2.5.0 and botocore 1.40.53
The conflict is caused by:
    botocore 1.40.53 depends on urllib3<1.27 and >=1.25.4; python_version < "3.10"
```

**原因**:
- pipが `--platform manylinux2014_x86_64` 使用時に依存関係マーカーをローカル環境（Python 3.12）で評価
- botocore 1.40.53の依存関係に `python_version < "3.10"` 条件があるが、新しいpipでも競合検出

**試行した解決策**:
1. ❌ `pip` → "command not found"
2. ❌ `uv pip` → プラットフォーム名の違い、プロジェクトが必要
3. ❌ `python3 -m pip install --upgrade pip` → システムpipのため反映されず
4. ✅ `--use-deprecated=legacy-resolver` を使用

**最終解決策**:
```bash
python3 -m pip install \
  --platform manylinux2014_x86_64 \
  --target=./package \
  --implementation cp \
  --python-version 3.12 \
  --only-binary=:all: \
  --upgrade \
  --use-deprecated=legacy-resolver \
  -r requirements.txt
```

**警告は無視して問題なし**:
```
ERROR: pip's legacy dependency resolver does not consider dependency conflicts
botocore 1.40.53 requires urllib3<1.27,>=1.25.4; python_version < "3.10"
but you'll have urllib3 2.5.0 which is incompatible.
```

→ これは `python_version < "3.10"` 条件のため、Python 3.12環境では問題なし

## デプロイスクリプトの最終形

```bash
echo "Step 3: Exporting dependencies from uv..."
cd ../..
uv export --no-hashes --no-dev --format requirements-txt > lambda/puzzle-register/requirements-full.txt

# プロジェクト自身を除外
grep -v "jigsaw-puzzle" lambda/puzzle-register/requirements-full.txt | \
  grep -v "^-e " | \
  grep -v "file://" > lambda/puzzle-register/requirements.txt

rm lambda/puzzle-register/requirements-full.txt
cd lambda/puzzle-register

echo "Step 4: Installing dependencies for Linux (Lambda runtime)..."
mkdir -p package

python3 -m pip install \
  --platform manylinux2014_x86_64 \
  --target=./package \
  --implementation cp \
  --python-version 3.12 \
  --only-binary=:all: \
  --upgrade \
  --use-deprecated=legacy-resolver \
  -r requirements.txt

echo "Step 5: Packaging Lambda function..."
cd package
zip -r ../function.zip . -q
cd ..

zip -ur function.zip index.py backend/ \
    -x "*.env*" "*/__pycache__/*" "*.pyc" "*.pyo" ".DS_Store" \
    -q
```

## テスト結果

### デプロイ成功
```
Package size: 24M
Deployment Complete! ✅
```

### エンドポイントテスト

**GET /users/anonymous/puzzles**:
```bash
curl -H "Origin: https://dykwhpbm0bhdv.cloudfront.net" \
  https://hbwku63803.execute-api.ap-northeast-1.amazonaws.com/dev/users/anonymous/puzzles
```
✅ HTTP 200、17件のパズルデータ返却、CORSヘッダー正常

**GET /puzzles/{puzzleId}**:
```bash
curl "https://hbwku63803.execute-api.ap-northeast-1.amazonaws.com/dev/puzzles/048db3cc-12b4-4372-b9a8-06c3924aaac0?user_id=anonymous"
```
✅ HTTP 200、パズル詳細データ返却

## 効果

### コード削減
- `lambda/puzzle-register/index.py`: 350行 → 19行（▼331行）
- `scripts/deploy-lambda.sh`: +16行
- **純削減**: ▼315行

### メリット
1. **コード重複の解消**: FastAPIとLambdaで同一コードを使用
2. **保守性向上**: エンドポイント追加時、FastAPIルートに追加するだけで自動的にLambdaでも利用可能
3. **バグリスク低減**: ローカルとLambdaの挙動差異がほぼゼロに
4. **テスト効率化**: ローカルでテストすれば、本番でも動作保証

### 今後の注意点
1. **依存関係の更新**: `--use-deprecated=legacy-resolver` は非推奨のため、将来的にDocker化を検討
2. **パッケージサイズ**: 現在24MB、Lambda制限は50MB（圧縮後）なので余裕あり
3. **コールドスタート**: Mangum自体は軽量だが、FastAPIアプリ全体がロードされるため要監視

## 参考資料

- Mangum公式ドキュメント: https://mangum.io/
- AWS Lambda Python依存関係: https://docs.aws.amazon.com/lambda/latest/dg/python-package.html
- pip --platform フラグの既知の問題: https://github.com/pypa/pip/issues/9180
