# uv 使い方ガイド

このプロジェクトは **uv** でPythonの依存関係を管理しています。

## uvとは

- Rustで書かれた超高速なPythonパッケージマネージャー
- pip, venv, pyenvの機能を統合
- `pyproject.toml` で依存関係を管理
- pipより10-100倍高速

公式サイト: https://docs.astral.sh/uv/

---

## インストール

### macOS / Linux
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### Windows
```powershell
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

### 確認
```bash
uv --version
```

---

## 基本的な使い方

### プロジェクトのセットアップ

```bash
# プロジェクトディレクトリに移動
cd jigsaw-puzzle

# Python 3.12をインストール & 依存関係をインストール
uv sync

# これだけで完了！
# 以下が自動で実行されます:
# - Python 3.12のインストール
# - 仮想環境の作成（.venv）
# - pyproject.tomlに記載された依存関係のインストール
```

### 仮想環境の有効化

```bash
# macOS / Linux
source .venv/bin/activate

# Windows
.venv\Scripts\activate

# プロンプトが (.venv) と表示されればOK
```

### パッケージの追加

```bash
# 本番用の依存関係を追加
uv add requests

# 開発用の依存関係を追加
uv add --dev pytest black ruff

# pyproject.tomlに自動で追記されます
```

### パッケージの削除

```bash
uv remove requests
```

### パッケージの更新

```bash
# 全てのパッケージを更新
uv sync --upgrade

# 特定のパッケージを更新
uv add fastapi --upgrade
```

### プログラムの実行

```bash
# uvを使って直接実行（仮想環境の有効化不要）
uv run python backend/app.py

# または
uv run uvicorn backend.app:app --reload

# 仮想環境を有効化してから実行することも可能
source .venv/bin/activate
python backend/app.py
```

---

## よく使うコマンド

### 依存関係の一覧表示

```bash
uv pip list
```

### インストール済みパッケージの確認

```bash
uv pip show fastapi
```

### requirements.txtの生成（Lambda用）

```bash
# Lambda用にrequirements.txtを生成
uv export --no-hashes --format requirements-txt > requirements.txt
```

### 仮想環境の再作成

```bash
# 仮想環境を削除
rm -rf .venv

# 再作成
uv sync
```

### Python バージョンの切り替え

```bash
# Python 3.12をインストール
uv python install 3.12

# Python 3.13をインストール
uv python install 3.13

# .python-version を編集してバージョンを変更
echo "3.13" > .python-version

# 再セットアップ
uv sync
```

---

## プロジェクトでの使い方

### 新しい依存関係を追加する

1. パッケージを追加
```bash
uv add pillow
```

2. `pyproject.toml` を確認
```bash
cat pyproject.toml
# dependencies に pillow が追加されていることを確認
```

3. Gitにコミット
```bash
git add pyproject.toml
git commit -m "Add pillow dependency"
```

### 他の開発者が依存関係を取得

```bash
# リポジトリをクローン
git clone <repo-url>
cd jigsaw-puzzle

# 依存関係をインストール
uv sync

# これだけでOK！
```

---

## Lambdaへのデプロイ

uvは開発環境で使い、Lambdaには `requirements.txt` を生成してデプロイします。

```bash
# デプロイスクリプトを実行
./scripts/deploy-lambda.sh

# スクリプト内部で以下が実行されます:
# 1. uv export で requirements.txt を生成
# 2. Lambda関数をパッケージング
# 3. AWSにデプロイ
```

---

## pyproject.toml の構造

```toml
[project]
name = "jigsaw-puzzle"
version = "0.1.0"
requires-python = ">=3.12,<3.13"
dependencies = [
    "fastapi>=0.104.0",      # 本番用の依存関係
    "boto3>=1.28.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=7.4.0",         # 開発用の依存関係
    "black>=23.0.0",
]
```

### 依存関係の種類

- `dependencies`: 本番環境で必要なパッケージ
- `[project.optional-dependencies].dev`: 開発時のみ必要なパッケージ

---

## トラブルシューティング

### エラー: uv: command not found

**原因:** uvがインストールされていない

**解決方法:**
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
# シェルを再起動
```

### エラー: Python 3.12 が見つからない

**解決方法:**
```bash
uv python install 3.12
```

### エラー: パッケージの依存関係が解決できない

**解決方法:**
```bash
# キャッシュをクリア
rm -rf .venv
uv cache clean
uv sync
```

### エラー: ImportError: No module named 'xxx'

**原因:** 仮想環境が有効化されていない、または依存関係がインストールされていない

**解決方法:**
```bash
# 依存関係を再インストール
uv sync

# 仮想環境を有効化
source .venv/bin/activate

# または uvを使って実行
uv run python your_script.py
```

---

## uvとpipの比較

| 操作 | pip | uv |
|------|-----|-----|
| **セットアップ** | `python -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt` | `uv sync` |
| **パッケージ追加** | `pip install requests && pip freeze > requirements.txt` | `uv add requests` |
| **パッケージ削除** | `pip uninstall requests && pip freeze > requirements.txt` | `uv remove requests` |
| **パッケージ更新** | `pip install --upgrade requests && pip freeze > requirements.txt` | `uv add requests --upgrade` |
| **実行** | `source .venv/bin/activate && python script.py` | `uv run python script.py` |
| **速度** | 遅い | 超高速（10-100倍） |

---

## 推奨ワークフロー

### 毎日の開発

```bash
# 1. プロジェクトディレクトリに移動
cd jigsaw-puzzle

# 2. 最新の依存関係を取得（チームメンバーが更新した場合）
git pull
uv sync

# 3. 開発サーバーを起動
uv run uvicorn backend.app:app --reload

# 4. コーディング...

# 5. 新しいパッケージが必要になったら
uv add requests

# 6. コミット
git add pyproject.toml
git commit -m "Add requests dependency"
git push
```

### Lambdaへのデプロイ

```bash
# デプロイスクリプトを実行するだけ
./scripts/deploy-lambda.sh
```

---

## まとめ

- **uv sync**: 依存関係をインストール（最初に一度だけ）
- **uv add**: パッケージを追加
- **uv remove**: パッケージを削除
- **uv run**: プログラムを実行（仮想環境の有効化不要）

**uvは高速で使いやすい最新のツールです。ぜひ活用してください！**
